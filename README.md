# API Template

API Templates act as foundations for developers to start building APIs. The template utilises the following (1 & 2) via the common services application: https://github.com/CondeNast/mule-atlas-common-services and 3 is embedded within the template itself. 

1. **JSON Logger**: This is used for Logging in the API and is a custom plugin. This is present at https://github.com/mulesoft-consulting/json-logger.
2. **Error Handler Plugin**: This is a common error handler that is fully customisable and is used by the template to handle errors. In case of an error the On Error Propagate is used which sends the information to the error handler which then handles the error, maps to the error object and prints it. This is present at https://github.com/mulesoft-consulting/error-handler-plugin/tree/420.
3. **Mule Secure Properties**: Uses the Mule Secure Properties connector so that encrypted property values can be used.

## Template Features

1. **Logging** - Uses the JSON Logger to implement well structured logs.
2. **Error Handling** - Uses the Error Handler Plugin to conduct some degree of standardised error handling/responses.
3. **API Autodiscovery** - Is preconfigured with API Autodiscovery and only the API ID needs to be provided in the relevant environment properties file.
4. **Preconfigured APIKIT Router** - Uses the APIKit router which has been configured with the necessary information
5. **Secure and Insecure Property Handling**


## Using the API Template

- Open Anypoint Studio and click **File > New > Project from Template**.

- Click on Open and the template will open in **Anypoint Studio**.

- Right click on the project name under Package explorer and rename it to the desired name of your application.
- In the POM file, change the value of the **artifactId** element to the name of **your-application-name** defined above. Also change the value of the **version** element to **1.0.0** if not already at **1.0.0**.
- In the POM file, change the value of the **name** element to **your-application-name**.
- Save the POM file.

- In the **log4j2.xml** file under **src/main/resources**, search for **mule-api-template** and replace all occurrences of it with **your-application-name**.
- To develop your application, you may need to import the RAML for the API Specification for which you need to write the implementation for. To do that right click on the application in **Package Explorer** and click on **Anypoint Platform > Import from Design Center**.

- Choose the right Business Group from the drop down and then choose the API Definition for which you are creating the implementation for and click OK. When prompted again, click Yes.
- This will download the **RAML** from **Design Center** into **Studio** and a file will be created automatically under **src/main/mule** with the name of API definition and with the **.xml** prefix. For example if the name of the API Definition was **my-system-api**, then the generated file under **src/main/mule** would be **my-system-api.xml**.
- Navigate to **src/main/resources/api** and rename the downloaded RAML under **src/main/resources/api** to **api.raml**.
- Now delete the file that was generated under **src/main/mule** folder. For example if the file name was **my-system-api.xml**, please delete that file.
- Now right click on **api.raml** and click on **Mule > Generate Flows from REST API**.
- This will create a new file named **api.xml** under **src/main/mule**. This file has the scaffolding generated by the APIKit.
- Open this file remove the flows named **api-main** and **api-console**.
- Next click on **Global Elements** and remove the **Global Element** for the **Router**. Once removed save the file.
- The **interface.xml** file under **src/main/mule** models a few sample flows which are based on the API Definition that is used by the API Template. These flows are to only be used for understanding the template but when you have added your own API definition, please delete the flows.
- Now open the file named **api.xml** under **src/main/mule** and click **Configuration XML**. Now copy all the flows from this file. Once you have copied all the flows paste them to the file named **interface.xml** under src/main/mule.
- To paste the flows, open **interface.xml** and click on **Configuration XML**. Once pasted, save the file.
- Now delete the file named **api.xml**.
- For all the JSON Loggers that you add in the implementations, ensure that under the Advanced Tab, the **Correlation id** is set to  **vars.'x-root-correlation-id'**

## API Configurations

Every Mule application can have 3 types of configurations, **properties** , **keystores** and **truststores**. Properties are used to pass static and dynamic values to the code and keystores and truststores are used to enable mutual SSL for applications.

### Properties

Properties can either be **static** or **dynamic**.

##### Static Properties

Static properties are constants that do not change when an application is promoted from one environment to other. They remain static at all times. Such kind of properties can be defined in the **common-env-properties.yaml** file in the API Template. This file is present under **src/main/resources/properties**. The syntax to read a static property is **${prop.name}**.

##### Dynamic Properties

The properties that change between environments when an application is promoted from one to the other are called dynamic properties. We can further divide dynamic properties into **Secure** and **Insecure** properties.

The API Template supports having such properties configured in the property files named **{env}-properties.yaml** where env-prefix can be **local**, **dev**, **prototype**, **sit**, **uat** and **prod**.

##### Insecure Dynamic Properties

These properties do not need to be hidden from a user but can change from one environment to the other.

##### Secure Dynamic Properties

These properties are generally credentials or secrets which need to hidden from the user.  The properties stored in these files are stored in an encrypted manner and can be accessed by the application as **${secure::prop.name}**.

##### Encrypting Properties

Secure Properties need to be added in an encrypted fashion. The values can be encrypted by running the following command in a command prompt:

```
java -jar secure-properties-tool.jar <method> <operation> <algorithm> <mode> <key> <value>
```

- **method** is hardcoded to string
- **operation** takes the values encrypt or decrypt
- **algorithm** is the encryption algorithm
- **mode** is the encryption mode
- **key** is the encryption/decryption key
- **value** is the plain text value that needs to encrypted or the encrypted value that needs to be decrypted

Once the value is encrypted it can be added as

```
prop.name=![encryptedValue]
```

where **prop.name** is the name of your encrypted property


### Keystores

Keystores are used to enable TLS access to applications. To use keystores store the keystores under **src/main/resources/keystores**

------

## Editing the mule-artifact.json

Under the root folder of the project open the mule-artifact.json

Perform the following updates in this file,

- **secureProperties**: When an application is deployed to CloudHub some properties need to be set as hidden and not encrypted. For example the encryption/decryption key that is used to decrypt the encrypted values should not be stored as plain text and should be hidden from plain sight. You can define that property name here. The mule.key property which is used to store the key is already defined here. If there are any other properties that need to be safely hidden provide them here as comma separated values.
- **minMuleVersion**: The runtime version for which this application is created for.
- **requiredProduct**: Leave it set to MULE\_EE

------

## Logging

The API Template shows an example for doing logging and uses the JSON Logger which is custom extension that automatically formats the logs to a JSON Object.

## Deploying

The mule maven plugin and cloudhub deployment options have been parameterised. 

An example of a deployment command with parameters:

mvn clean package deploy -DmuleDeploy -Ddeploy.username=** -Ddeploy.password=** -Dmule.env=dev -Daws.region=eu-west-2 -Dworker.count=1 -Dworker.type=MICRO -Dmule.encryption.key=** -Denv.anypoint.client.id=**  -Denv.anypoint.client.secret=** -Dbusiness.group=Atlas\\Global
